name: Nuxt 3 Production Deployment

on:
  push:
    branches:
      - main # 只有推送到 main 分支才触发部署

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest # 在 GitHub 的云端机器上运行

    steps:
      - name: 1. Checkout 仓库代码
        uses: actions/checkout@v4

      - name: 2. Setup Node.js 环境
        uses: actions/setup-node@v4
        with:
          node-version: "20" # 确保与您的服务器 Node.js 版本一致
      - name: 2.1. 安装 pnpm
        uses: pnpm/action-setup@v3 # 这是一个专门用于安装 pnpm 的 Action
        with:
          version: 8 # 指定 pnpm 版本
          run_install: false
      - name: 3. 安装依赖和构建项目 (CI)
        run: |
          pnpm install
          pnpm run build # 编译生成 .output 目录

      - name: 4. 部署到阿里云服务器 (CD)
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}

          script: |
            PROJECT_DIR="${{ secrets.DEPLOY_PATH }}" 
            APP_NAME="ancho_solana_js"

            # 1. 创建目录并进入
            mkdir -p $PROJECT_DIR
            cd $PROJECT_DIR

            # 2. 清理旧的 .output 目录
            rm -rf .output

            # 3. [关键修复] 使用 SCP/Rsync 复制所有所需文件 (替换了之前的复杂逻辑)

            # a) 复制项目根目录下的所有文件 (package.json, nuxt.config.js, .env, etc.)
            # 注意：这里的 . 是指 GitHub Actions 机器上的工作目录
            scp -r ${{ github.workspace }}/. ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:'${{ secrets.DEPLOY_PATH }}'

            # b) 清理服务器上不需要的文件夹 (排除 node_modules 和 .git)
            rm -rf node_modules .git

            # 4. 重启 PM2 进程
            pm2 reload $APP_NAME 2>/dev/null || \
            pm2 start npm --name "$APP_NAME" -- run start
