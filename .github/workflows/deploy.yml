name: Nuxt 3 Production Deployment

on:
  push:
    branches:
      - main

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    steps:
      - name: 1. Checkout 仓库代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 获取完整历史，避免权限问题

      - name: 2. Setup Node.js 环境
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: 'pnpm'  # 添加pnpm缓存

      - name: 2.1. 安装 pnpm
        run: npm install -g pnpm

      - name: 3. 安装依赖和构建项目
        run: |
          pnpm install
          pnpm run build

      - name: 4.0. 清理敏感文件和缓存
        run: |
          # 清理可能引起权限问题的文件
          rm -rf .git/hooks/*
          find .git/objects -type f -exec chmod 644 {} \;
          
          # 创建干净的发布目录
          mkdir -p dist
          cp -r .output dist/
          cp package.json pnpm-lock.yaml dist/
          cp .env.example dist/.env.production
          
          # 移除.git目录
          rm -rf dist/.git

      - name: 4.1. 使用rsync同步文件到服务器
        uses: burnett01/rsync-deployments@v6.0.0  # 使用rsync更可靠
        with:
          switches: -avz --delete
          path: dist/  # 只同步构建后的dist目录
          remote_path: ${{ secrets.DEPLOY_PATH }}
          remote_host: ${{ secrets.SERVER_HOST }}
          remote_user: ${{ secrets.SERVER_USER }}
          remote_key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: 4.2. 在服务器执行部署
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # ===== 服务器端部署脚本 =====
            set -e  # 遇到错误立即退出
            
            PROJECT_DIR="${{ secrets.DEPLOY_PATH }}"
            APP_NAME="ancho_solana_js"
            
            echo "🚀 开始部署到: $PROJECT_DIR"
            
            # 1. 修复目录权限
            echo "🔧 修复权限..."
            sudo chown -R ${{ secrets.SERVER_USER }}:${{ secrets.SERVER_USER }} $PROJECT_DIR 2>/dev/null || true
            find $PROJECT_DIR -type d -exec chmod 755 {} \;
            find $PROJECT_DIR -type f -exec chmod 644 {} \;
            
            # 2. 清理残留的.git目录（如果有）
            find $PROJECT_DIR -name ".git" -type d -exec rm -rf {} + 2>/dev/null || true
            
            # 3. 进入项目目录
            cd $PROJECT_DIR
            
            # 4. 生产环境依赖安装
            echo "📦 安装生产依赖..."
            if [ -f pnpm-lock.yaml ]; then
              pnpm install --prod --frozen-lockfile
            elif [ -f package-lock.json ]; then
              npm ci --only=production
            else
              npm install --only=production
            fi
            
            # 5. 确保环境文件存在
            if [ ! -f .env.production ]; then
              if [ -f .env.example ]; then
                cp .env.example .env.production
                echo "⚠️  请编辑 .env.production 文件"
              fi
            fi
            
            # 6. PM2应用管理
            echo "🔄 管理PM2进程..."
            
            # 创建PM2配置文件
            cat > ecosystem.config.js << 'EOF'
            module.exports = {
              apps: [{
                name: "$APP_NAME",
                script: 'node_modules/.bin/nuxi',
                args: 'start',
                cwd: '$PROJECT_DIR',
                instances: 1,
                exec_mode: 'fork',
                max_memory_restart: '500M',
                env: {
                  NODE_ENV: 'production',
                  PORT: 3000
                },
                error_file: '/var/log/nuxt-app/err.log',
                out_file: '/var/log/nuxt-app/out.log',
                merge_logs: true,
                time: true,
                autorestart: true
              }]
            }
            EOF
            
            # 启动或重启应用
            if pm2 list | grep -q "$APP_NAME"; then
              echo "🔄 重启现有应用..."
              pm2 reload ecosystem.config.js --update-env
            else
              echo "🚀 启动新应用..."
              pm2 start ecosystem.config.js
            fi
            
            pm2 save 2>/dev/null || true
            
            # 7. 健康检查
            echo "🏥 执行健康检查..."
            sleep 8  # 给应用启动时间
            
            MAX_RETRIES=5
            for i in $(seq 1 $MAX_RETRIES); do
              if curl -s -f "http://localhost:3000/api/health" > /dev/null 2>&1; then
                echo "✅ 应用启动成功 (尝试 $i 次)"
                break
              fi
              
              if [ $i -eq $MAX_RETRIES ]; then
                echo "❌ 应用启动失败，查看日志..."
                pm2 logs "$APP_NAME" --lines 30
                exit 1
              fi
              
              echo "⏳ 等待应用启动... ($i/$MAX_RETRIES)"
              sleep 3
            done
            
            echo "🎉 部署完成！"
            echo "🔗 访问: http://localhost:3000"
            # ===== 脚本结束 =====